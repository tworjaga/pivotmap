"""
Exploit database integration.

Provides exploit maturity metadata and attack pattern mappings.
"""

from typing import Any, Optional

from pivotmap.core.models import ExploitMaturity


class ExploitDB:
    """
    Exploit database for maturity tracking and metadata.

    Maps CVEs to available exploits and attack patterns.
    """

    def __init__(self) -> None:
        """Initialize exploit database."""
        self._exploits: dict[str, dict[str, Any]] = {}
        self._attack_patterns: dict[str, dict[str, Any]] = {}

    def load_exploits(self, exploits_data: dict[str, Any]) -> int:
        """
        Load exploit metadata.

        Args:
            exploits_data: Dictionary mapping CVE IDs to exploit info

        Returns:
            Number of exploits loaded
        """
        self._exploits.update(exploits_data)
        return len(self._exploits)

    def get_exploit(self, cve_id: str) -> Optional[dict[str, Any]]:
        """
        Get exploit information for a CVE.

        Args:
            cve_id: CVE identifier

        Returns:
            Exploit metadata or None
        """
        return self._exploits.get(cve_id)

    def has_exploit(self, cve_id: str) -> bool:
        """Check if exploit exists for CVE."""
        return cve_id in self._exploits

    def get_maturity(self, cve_id: str) -> ExploitMaturity:
        """
        Get exploit maturity for CVE.

        Args:
            cve_id: CVE identifier

        Returns:
            Exploit maturity level
        """
        exploit: Optional[dict[str, Any]] = self._exploits.get(cve_id)

        if not exploit:
            return ExploitMaturity.NOT_DEFINED

        maturity_str: str = exploit.get("maturity", "not_defined")
        try:
            return ExploitMaturity(maturity_str)
        except ValueError:
            return ExploitMaturity.NOT_DEFINED

    def load_attack_patterns(self, patterns: dict[str, Any]) -> int:
        """
        Load MITRE ATT&CK pattern mappings.

        Args:
            patterns: Dictionary of attack patterns

        Returns:
            Number of patterns loaded
        """
        self._attack_patterns.update(patterns)
        return len(self._attack_patterns)

    def get_attack_pattern(self, cve_id: str) -> Optional[dict[str, Any]]:
        """
        Get MITRE ATT&CK pattern for CVE.

        Args:
            cve_id: CVE identifier

        Returns:
            Attack pattern mapping or None
        """
        return self._attack_patterns.get(cve_id)

    def get_statistics(self) -> dict[str, Any]:
        """Return database statistics."""
        maturity_counts: dict[str, int] = {}

        for exploit in self._exploits.values():
            mat: str = exploit.get("maturity", "not_defined")
            maturity_counts[mat] = maturity_counts.get(mat, 0) + 1

        return {
            "exploit_count": len(self._exploits),
            "attack_pattern_count": len(self._attack_patterns),
            "maturity_distribution": maturity_counts,
        }
